<html>

<head>
 <title>John Mills</title>
 <meta charset="utf-8">
 <meta name="viewport" content="width=device-width">
 <link rel="stylesheet" href="https://iamjohnmills.github.io/journal/assets/site.css" />
 <script src="https://iamjohnmills.github.io/journal/assets/site.js"></script>
</head>

<body>
 <header>
  <div data-toggle-nav="true">
   <svg width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <path fill="#33363F" d="m4 10-.707.707L2.586 10l.707-.707L4 10Zm17 8a1 1 0 1 1-2 0h2ZM8.293 15.707l-5-5 1.414-1.414 5 5-1.414 1.414Zm-5-6.414 5-5 1.414 1.414-5 5-1.414-1.414ZM4 9h10v2H4V9Zm17 7v2h-2v-2h2Zm-7-7a7 7 0 0 1 7 7h-2a5 5 0 0 0-5-5V9Z" />
   </svg> More Articles
  </div>
  <a class="button" href="https://iamjohnmills.github.io/journal/johnmills.rss">
   <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 100 100" xml:space="preserve">
    <path d="M26.258 64.949a8.78 8.78 0 0 0-8.78 8.784 8.782 8.782 0 1 0 17.564 0 8.78 8.78 0 0 0-8.784-8.784z" />
    <path d="M23.536 40.801c-.046 0-.09.006-.135.007v-.007h-3.464v.039a3.437 3.437 0 0 0-3.056 3.344h-.007v6.159h.041a3.43 3.43 0 0 0 3.021 3.002v.039H23.4v-.048c.045.001.09.007.135.007 12.772 0 23.173 10.321 23.311 23.061h-.033v3.464h.039a3.437 3.437 0 0 0 3.344 3.056v.007h6.158v-.041a3.43 3.43 0 0 0 3.002-3.021h.039v-3.464h-.006c-.137-19.657-16.166-35.604-35.853-35.604z" />
    <path d="M83.119 76.403C82.98 43.664 56.308 17.07 23.536 17.07c-.046 0-.09.006-.135.007v-.007h-3.464v.039a3.437 3.437 0 0 0-3.056 3.344h-.007v6.159h.041a3.429 3.429 0 0 0 3.021 3.002v.039H23.4v-.048c.045.001.09.007.135.007 25.857 0 46.902 20.967 47.041 46.792h-.035v3.464h.039a3.437 3.437 0 0 0 3.344 3.056v.007h6.159v-.041a3.43 3.43 0 0 0 3.002-3.021h.039v-3.464h-.005z" />
   </svg> RSS </a>
 </header>
 <main>
  <nav>
   <span>I mostly post minimal experiments, tips, and tricks. Keep up-to-date with me and subscribe to my <a href="https://iamjohnmills.github.io/journal/johnmills.rss" target="_blank">RSS Feed</a></span>
   <a href="https:&#x2F;&#x2F;iamjohnmills.github.io&#x2F;journal&#x2F;d3-orthographic-image&#x2F;">Orthographic Image Projection with D3</a><a href="https:&#x2F;&#x2F;iamjohnmills.github.io&#x2F;journal&#x2F;animated-nav-icon&#x2F;">Animated Nav Menu</a><a href="https:&#x2F;&#x2F;iamjohnmills.github.io&#x2F;journal&#x2F;vector-earth&#x2F;">Vector Earth 3D</a><a href="https:&#x2F;&#x2F;iamjohnmills.github.io&#x2F;journal&#x2F;giftv&#x2F;">GifTV</a><a href="https:&#x2F;&#x2F;iamjohnmills.github.io&#x2F;journal&#x2F;shaders&#x2F;">WebGL shaders</a><a href="https:&#x2F;&#x2F;iamjohnmills.github.io&#x2F;journal&#x2F;n64&#x2F;">Spinning N64 logo</a><a href="https:&#x2F;&#x2F;iamjohnmills.github.io&#x2F;journal&#x2F;chat-bubbles&#x2F;">Chat bubbles</a><a href="https:&#x2F;&#x2F;iamjohnmills.github.io&#x2F;journal&#x2F;canvas-video&#x2F;">Video to canvas</a><a href="https:&#x2F;&#x2F;iamjohnmills.github.io&#x2F;journal&#x2F;90s-shapes&#x2F;">90s abstract shapes</a><a href="https:&#x2F;&#x2F;iamjohnmills.github.io&#x2F;journal&#x2F;equalizer&#x2F;">Animated equalizer</a><a href="https:&#x2F;&#x2F;iamjohnmills.github.io&#x2F;journal&#x2F;synthwave-highway&#x2F;">Synthwave highway</a><a href="https:&#x2F;&#x2F;iamjohnmills.github.io&#x2F;journal&#x2F;plasma&#x2F;">Plasma</a><a href="https:&#x2F;&#x2F;iamjohnmills.github.io&#x2F;journal&#x2F;matrix&#x2F;">Matrix</a><a href="https:&#x2F;&#x2F;iamjohnmills.github.io&#x2F;journal&#x2F;cursor-follow&#x2F;">Follow mouse cursor</a><a href="https:&#x2F;&#x2F;iamjohnmills.github.io&#x2F;journal&#x2F;game-of-life&#x2F;">Game of life</a><a href="https:&#x2F;&#x2F;iamjohnmills.github.io&#x2F;journal&#x2F;create-node&#x2F;">My one-function JS framework</a>
  </nav>
  <section>
   <p>Mar 2024</p>
   <h1>Orthographic Image Projection with D3</h1>
   <p>In this example, I take a flat image and simulate a 3D effect onto a spherical projection with D3.</p>
   <pre data-code="%3Chtml%3E%0A%3Chead%3E%0A%20%20%3Ctitle%3EOrthographic%20Image%20Projection%20with%20D3%3C%2Ftitle%3E%0A%20%20%3Cscript%20src%3D%22d3.v3.min.js%22%20charset%3D%22utf-8%22%3E%3C%2Fscript%3E%0A%20%20%3Cscript%20src%3D%22d3-geo.v1.min.js%22%3E%3C%2Fscript%3E%0A%20%20%3Cscript%20src%3D%22versor.js%22%3E%3C%2Fscript%3E%0A%20%20%3Cscript%3E%0A%20%20const%20createNode%20%3D%20(options)%20%3D%3E%20%7B%0A%20%20%20%20const%20node%20%3D%20document.createElement(options.tag)%3B%0A%20%20%20%20if(options.className)%20node.setAttribute('class'%2Coptions.className)%3B%0A%20%20%20%20if(options.innerHTML)%20node.innerHTML%20%3D%20options.innerHTML%3B%0A%20%20%20%20if(options.attributes)%20Object.keys(options.attributes).forEach(key%20%3D%3E%20node.setAttribute(key%2Coptions.attributes%5Bkey%5D)%20)%3B%0A%20%20%20%20if(options.style)%20Object.keys(options.style).forEach(key%20%3D%3E%20node.style%5Bkey%5D%20%3D%20options.style%5Bkey%5D)%3B%0A%20%20%20%20if(options.root)%20options.root.appendChild(node)%3B%0A%20%20%20%20return%20node%3B%0A%20%20%7D%0A%20%20const%20getImageData%20%3D%20(%7B%20src%2C%20size%20%7D)%20%3D%3E%20new%20Promise(resolve%20%3D%3E%20%7B%0A%20%20%20%20const%20shadow_canvas%20%3D%20document.createElement('canvas')%3B%0A%20%20%20%20const%20shadow_context%20%3D%20shadow_canvas.getContext('2d')%3B%0A%20%20%20%20const%20image%20%3D%20new%20Image()%3B%0A%20%20%20%20image.onload%20%3D%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20const%20ratio%20%3D%20Math.min(image.naturalWidth%20%2F%20size%2C%20size%20%2F%20image.naturalHeight)%3B%0A%20%20%20%20%20%20let%20draw_width%20%3D%20Math.ceil(image.naturalWidth%20*%20ratio)%3B%0A%20%20%20%20%20%20let%20draw_height%20%3D%20Math.ceil(image.naturalHeight%20*%20ratio)%3B%0A%20%20%20%20%20%20shadow_canvas.setAttribute('width'%2C%20draw_width)%3B%0A%20%20%20%20%20%20shadow_canvas.setAttribute('height'%2C%20draw_height)%3B%0A%20%20%20%20%20%20shadow_context.drawImage(image%2C%200%2C%200%2C%20image.naturalWidth%2C%20image.naturalHeight%2C%200%2C%200%2C%20draw_width%2C%20draw_height)%3B%0A%20%20%20%20%20%20var%20imageData%20%3D%20shadow_context.getImageData(0%2C%200%2C%20draw_width%2C%20draw_height)%3B%0A%20%20%20%20%20%20return%20resolve(%7B%20data%3A%20imageData.data%2C%20width%3A%20draw_width%2C%20height%3A%20draw_height%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20image.src%20%3D%20src%3B%20%0A%20%20%7D)%0A%20%20class%20App%20%7B%0A%20%20%20%20constructor()%7B%0A%20%20%20%20%20%20document.addEventListener('DOMContentLoaded'%2Cthis.init.bind(this))%3B%0A%20%20%20%20%20%20document.addEventListener('touchmove'%2C%20this.handleMousemove.bind(this))%3B%0A%20%20%20%20%20%20document.addEventListener('mousemove'%2C%20this.handleMousemove.bind(this))%3B%0A%20%20%20%20%20%20document.addEventListener('mousedown'%2C%20this.handleMousedown.bind(this))%3B%0A%20%20%20%20%20%20document.addEventListener('touchstart'%2C%20this.handleMousedown.bind(this))%3B%0A%20%20%20%20%20%20document.addEventListener('mouseup'%2C%20this.handleMouseup.bind(this))%3B%0A%20%20%20%20%20%20document.addEventListener('touchend'%2C%20this.handleMouseup.bind(this))%3B%0A%20%20%20%20%20%20this.globes%20%3D%20%5B%5D%3B%0A%20%20%20%20%20%20this.els%20%3D%20%5B%5D%3B%0A%20%20%20%20%20%20this.frame%20%3D%200%3B%0A%20%20%20%20%20%20this.globe_size%20%3D%20360%3B%0A%20%20%20%20%20%20this.r1%20%3D%20%5B0%2C0%2C0%5D%3B%0A%20%20%20%20%20%20this.active%20%3D%20false%3B%0A%20%20%20%20%20%20this.processing%20%3D%20false%3B%0A%20%20%20%20%20%20this.grab_to_rotate%20%3D%20false%3B%0A%20%20%20%20%7D%0A%20%20%20%20async%20init()%7B%0A%20%20%20%20%20%20if(this.raf)%20cancelAnimationFrame(this.raf)%3B%0A%20%20%20%20%20%20this.root%20%3D%20document.getElementById('root')%3B%0A%20%20%20%20%20%20%2F%2F%20const%20load_image%20%3D%20await%20getImageData(%7B%20src%3A%20'earth.png'%2C%20size%3A%20this.globe_size%20%7D)%3B%0A%20%20%20%20%20%20%2F%2F%20this.map_image_data%20%3D%20load_image.data%3B%0A%20%20%20%20%20%20%2F%2F%20this.width%20%3D%20load_image.width%3B%0A%20%20%20%20%20%20%2F%2F%20this.height%20%3D%20load_image.height%3B%0A%20%20%20%20%20%20await%20this.setMapProjectionImage('earth.png')%3B%0A%20%20%20%20%20%20this.els.canvas_globe%20%3D%20createNode(%7B%20root%3A%20this.root%2C%20tag%3A%20'canvas'%2C%20attributes%3A%20%7B%20width%3A%20this.globe_size%2C%20height%3A%20this.globe_size%20%7D%20%7D)%3B%0A%20%20%20%20%20%20this.els.actions%20%3D%20createNode(%7B%20root%3A%20this.root%2C%20tag%3A%20'div'%2C%20className%3A%20'actions'%2C%20innerHTML%3A%20%60%0A%20%20%20%20%20%20%20%20%3Cbutton%20data-src%3D%22earth.png%22%3EEarth%3C%2Fbutton%3E%0A%20%20%20%20%20%20%20%20%3Cbutton%20data-src%3D%22moon.jpg%22%3EMoon%3C%2Fbutton%3E%0A%20%20%20%20%20%20%20%20%3Cbutton%20data-src%3D%22mars.jpeg%22%3EMars%3C%2Fbutton%3E%0A%20%20%20%20%20%20%20%20%3Cbutton%20data-src%3D%22spongebob.jpeg%22%3ESpongebob%3C%2Fbutton%3E%0A%20%20%20%20%20%20%20%20%3Cbutton%20data-grab_toggle%3D%22true%22%3EToggle%20Grab%3C%2Fbutton%3E%0A%20%20%20%20%20%20%60%20%7D)%3B%0A%20%20%20%20%20%20this.els.actions.addEventListener('click'%2Cthis.handleChangeMap.bind(this))%0A%20%20%20%20%20%20this.context%20%3D%20this.els.canvas_globe.getContext('2d')%3B%0A%20%20%20%20%20%20this.projection%20%3D%20d3.geo.orthographic().scale(%20(this.globe_size%20%2F%202)%20%2B%201.5).translate(%5Bthis.globe_size%20%2F%202%2C%20this.globe_size%20%2F%202%5D).rotate(%5B0%2C-20%2C-20%5D).clipAngle(90)%3B%0A%20%20%20%20%20%20this.path%20%3D%20d3.geo.path().projection(this.projection)%3B%0A%20%20%20%20%20%20this.lambda%20%3D%20d3.scale.linear().domain(%5B0%2C%20this.width%5D).range(%5B-180%2C%20180%5D)%3B%0A%20%20%20%20%20%20this.phi%20%3D%20d3.scale.linear().domain(%5B0%2C%20this.height%5D).range(%5B90%2C%20-90%5D)%3B%0A%20%20%20%20%20%20this.raf%20%3D%20window.requestAnimationFrame(this.render.bind(this))%3B%0A%20%20%20%20%7D%0A%20%20%20%20async%20setMapProjectionImage(src)%20%7B%0A%20%20%20%20%20%20const%20load_image%20%3D%20await%20getImageData(%7B%20src%3A%20src%2C%20size%3A%20this.globe_size%20%7D)%3B%0A%20%20%20%20%20%20this.map_image_data%20%3D%20load_image.data%3B%0A%20%20%20%20%20%20this.width%20%3D%20load_image.width%3B%0A%20%20%20%20%20%20this.height%20%3D%20load_image.height%3B%0A%20%20%20%20%7D%0A%20%20%20%20async%20handleChangeMap(event)%20%7B%0A%20%20%20%20%20%20if(event.target.dataset.src)%7B%0A%20%20%20%20%20%20%20%20await%20this.setMapProjectionImage(event.target.dataset.src)%3B%0A%20%20%20%20%20%20%7D%20else%20if(event.target.dataset.grab_toggle)%20%7B%0A%20%20%20%20%20%20%20%20this.grab_to_rotate%20%3D%20!this.grab_to_rotate%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20handleMousedown(event)%7B%0A%20%20%20%20%20%20this.active%20%3D%20!!event.target.closest('canvas')%3B%0A%20%20%20%20%20%20if(!this.active)%20return%3B%0A%20%20%20%20%20%20const%20clientX%20%3D%20!!event.touches%20%3F%20event.touches%5B0%5D.layerX%20%3A%20event.layerX%3B%0A%20%20%20%20%20%20const%20clientY%20%3D%20!!event.touches%20%3F%20event.touches%5B0%5D.layerY%20%3A%20event.layerY%3B%0A%20%20%20%20%20%20this.v0%20%3D%20versor.cartesian(this.projection.invert(%5BclientX%2C%20clientY%5D))%3B%0A%20%20%20%20%20%20this.r0%20%3D%20this.projection.rotate()%3B%0A%20%20%20%20%20%20this.q0%20%3D%20versor(this.r0)%3B%0A%20%20%20%20%7D%0A%20%20%20%20handleMousemove(event)%7B%0A%20%20%20%20%20%20if(!this.active)%20return%3B%0A%20%20%20%20%20%20const%20clientX%20%3D%20!!event.touches%20%3F%20event.touches%5B0%5D.layerX%20%3A%20event.layerX%3B%0A%20%20%20%20%20%20const%20clientY%20%3D%20!!event.touches%20%3F%20event.touches%5B0%5D.layerY%20%3A%20event.layerY%3B%20%20%20%20%20%20%0A%20%20%20%20%20%20this.v1%20%3D%20versor.cartesian(this.projection.rotate(this.r0).invert(%5BclientX%2C%20clientY%5D))%3B%0A%20%20%20%20%20%20this.q1%20%3D%20versor.multiply(this.q0%2C%20versor.delta(this.v0%2C%20this.v1))%3B%0A%20%20%20%20%20%20this.r1%20%3D%20versor.rotation(this.q1)%3B%0A%20%20%20%20%7D%0A%20%20%20%20handleMouseup(event)%7B%0A%20%20%20%20%20%20this.active%20%3D%20false%3B%0A%20%20%20%20%7D%0A%20%20%20%20updateLayerImageData(img_data)%7B%0A%20%20%20%20%20%20if(this.processing)%20return%3B%0A%20%20%20%20%20%20this.processing%20%3D%20true%3B%0A%20%20%20%20%20%20const%20data%20%3D%20new%20Uint8ClampedArray(img_data.length)%3B%0A%20%20%20%20%20%20for%20(let%20y%20%3D%200%3B%20y%20%3C%20this.height%3B%20%2B%2By)%20%7B%0A%20%20%20%20%20%20%20%20for%20(let%20x%20%3D%200%3B%20x%20%3C%20this.width%3B%20%2B%2Bx)%20%7B%0A%20%20%20%20%20%20%20%20%20%20const%20index%20%3D%20(y%20*%20this.width%20%2B%20x)%20*%204%3B%0A%20%20%20%20%20%20%20%20%20%20const%20%5Blambda%2Cphi%5D%20%3D%20this.projection.invert(%5Bx%2C%20y%5D)%3B%0A%20%20%20%20%20%20%20%20%20%20let%20imageX%20%3D%20Math.trunc((lambda%20%2B%20180)%20%2F%20360%20*%20this.width)%3B%20%0A%20%20%20%20%20%20%20%20%20%20let%20imageY%20%3D%20Math.trunc((90%20-%20phi)%20%2F%20180%20*%20this.height)%3B%0A%20%20%20%20%20%20%20%20%20%20const%20imageIndex%20%3D%20(imageY%20*%20this.width%20%2B%20imageX)%20*%204%3B%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20data%5Bindex%5D%20%3D%20img_data%5BimageIndex%5D%3B%0A%20%20%20%20%20%20%20%20%20%20data%5Bindex%20%2B%201%5D%20%3D%20img_data%5BimageIndex%20%2B%201%5D%3B%0A%20%20%20%20%20%20%20%20%20%20data%5Bindex%20%2B%202%5D%20%3D%20img_data%5BimageIndex%20%2B%202%5D%3B%0A%20%20%20%20%20%20%20%20%20%20data%5Bindex%20%2B%203%5D%20%3D%20255%3B%0A%20%20%20%20%20%20%20%20%20%20if(y%20%3D%3D%3D%20this.height%20-1%20%26%26%20x%20%3D%3D%3D%20this.width%20-1%20)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20this.processing%20%3D%20false%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20new%20ImageData(data%2C%20this.width%2C%20this.height)%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20async%20render()%7B%0A%20%20%20%20%20%20if(this.grab_to_rotate)%7B%0A%20%20%20%20%20%20%20%20this.projection.rotate(%5Bthis.r1%5B0%5D%2C%20this.r1%5B1%5D%2C%20this.r1%5B2%5D%5D)%3B%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20this.frame%20%2B%3D%201%3B%0A%20%20%20%20%20%20%20%20const%20rotation%20%3D%20this.frame%20*%200.5%3B%0A%20%20%20%20%20%20%20%20const%20lambda%20%3D%20this.lambda(rotation)%3B%0A%20%20%20%20%20%20%20%20this.projection.rotate(%5Blambda%20%2C%20-20%2C%20-20%20%5D)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20const%20updatedMapImageData%20%3D%20await%20this.updateLayerImageData(this.map_image_data)%3B%0A%20%20%20%20%20%20this.context.clearRect(0%2C%200%2C%20this.globe_size%2C%20this.globe_size)%3B%0A%20%20%20%20%20%20this.context.putImageData(updatedMapImageData%2C%200%2C%200)%3B%0A%20%20%20%20%20%20this.raf%20%3D%20window.requestAnimationFrame(this.render.bind(this))%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%20%20const%20app%20%3D%20new%20App()%3B%20%0A%20%20%3C%2Fscript%3E%0A%20%20%3Cstyle%3E%0A%20%20%20%20body%20%7B%20background%3A%20%23000%20%7D%0A%20%20%20%20%23root%20%7B%20width%3A%20100%25%3B%20height%3A%20500px%3B%20overflow%3A%20hidden%3B%20display%3A%20flex%3B%20flex-direction%3A%20column%3B%20align-items%3A%20center%3B%20justify-content%3A%20center%3B%20position%3A%20relative%3B%20z-index%3A%202%3B%20%7D%0A%20%20%20%20%23root%20%7B%20%0A%20%20%20%20%20%20background-image%3A%20%0A%20%20%20%20%20%20%20%20radial-gradient(2px%202px%20at%2020px%2030px%2C%20%23eee%2C%20rgba(0%2C0%2C0%2C0))%2C%0A%20%20%20%20%20%20%20%20radial-gradient(2px%202px%20at%2040px%2070px%2C%20%23fff%2C%20rgba(0%2C0%2C0%2C0))%2C%0A%20%20%20%20%20%20%20%20radial-gradient(2px%202px%20at%2050px%20160px%2C%20%23ddd%2C%20rgba(0%2C0%2C0%2C0))%2C%0A%20%20%20%20%20%20%20%20radial-gradient(2px%202px%20at%2090px%2040px%2C%20%23fff%2C%20rgba(0%2C0%2C0%2C0))%2C%0A%20%20%20%20%20%20%20%20radial-gradient(2px%202px%20at%20130px%2080px%2C%20%23fff%2C%20rgba(0%2C0%2C0%2C0))%2C%0A%20%20%20%20%20%20%20%20radial-gradient(2px%202px%20at%20160px%20120px%2C%20%23ddd%2C%20rgba(0%2C0%2C0%2C0))%3B%0A%20%20%20%20%20%20background-repeat%3A%20repeat%3B%20background-size%3A%20200px%20200px%20%7D%0A%20%20%20%20canvas%20%7B%20display%3A%20block%3B%20image-rendering%3A%20pixelated%3B%20border-radius%3A%2050%25%3B%20cursor%3A%20grab%3B%20position%3A%20relative%3B%20%7D%0A%20%20%20%20canvas%3Aactive%20%7B%20cursor%3A%20grabbing%3B%7D%0A%20%20%20%20.actions%20%7B%20padding%3A%2040px%200%200%200%3B%20%7D%0A%3C%2Fstyle%3E%0A%3C%2Fhead%3E%0A%3Cbody%3E%0A%20%20%3Cdiv%20id%3D%22root%22%3E%3C%2Fdiv%3E%0A%20%20%3Cdiv%20id%3D%22space%22%3E%0A%20%20%20%20%3Cdiv%20class%3D%22stars%22%3E%3C%2Fdiv%3E%0A%20%20%20%20%3Cdiv%20class%3D%22stars%22%3E%3C%2Fdiv%3E%0A%20%20%20%20%3Cdiv%20class%3D%22stars%22%3E%3C%2Fdiv%3E%0A%20%20%20%20%3Cdiv%20class%3D%22stars%22%3E%3C%2Fdiv%3E%0A%20%20%20%20%3Cdiv%20class%3D%22stars%22%3E%3C%2Fdiv%3E%0A%20%20%3C%2Fdiv%3E%0A%3C%2Fbody%3E%0A%3C%2Fhtml%3E%0A"><code class="hljs"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Orthographic Image Projection with D3<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;d3.v3.min.js&quot;</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;d3-geo.v1.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;versor.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript">
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">createNode</span> = (<span class="hljs-params">options</span>) =&gt; {
    <span class="hljs-keyword">const</span> node = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(options.<span class="hljs-property">tag</span>);
    <span class="hljs-keyword">if</span>(options.<span class="hljs-property">className</span>) node.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&#x27;class&#x27;</span>,options.<span class="hljs-property">className</span>);
    <span class="hljs-keyword">if</span>(options.<span class="hljs-property">innerHTML</span>) node.<span class="hljs-property">innerHTML</span> = options.<span class="hljs-property">innerHTML</span>;
    <span class="hljs-keyword">if</span>(options.<span class="hljs-property">attributes</span>) <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(options.<span class="hljs-property">attributes</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> node.<span class="hljs-title function_">setAttribute</span>(key,options.<span class="hljs-property">attributes</span>[key]) );
    <span class="hljs-keyword">if</span>(options.<span class="hljs-property">style</span>) <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(options.<span class="hljs-property">style</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> node.<span class="hljs-property">style</span>[key] = options.<span class="hljs-property">style</span>[key]);
    <span class="hljs-keyword">if</span>(options.<span class="hljs-property">root</span>) options.<span class="hljs-property">root</span>.<span class="hljs-title function_">appendChild</span>(node);
    <span class="hljs-keyword">return</span> node;
  }
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getImageData</span> = (<span class="hljs-params">{ src, size }</span>) =&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> shadow_canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;canvas&#x27;</span>);
    <span class="hljs-keyword">const</span> shadow_context = shadow_canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">&#x27;2d&#x27;</span>);
    <span class="hljs-keyword">const</span> image = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
    image.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> ratio = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(image.<span class="hljs-property">naturalWidth</span> / size, size / image.<span class="hljs-property">naturalHeight</span>);
      <span class="hljs-keyword">let</span> draw_width = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(image.<span class="hljs-property">naturalWidth</span> * ratio);
      <span class="hljs-keyword">let</span> draw_height = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(image.<span class="hljs-property">naturalHeight</span> * ratio);
      shadow_canvas.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&#x27;width&#x27;</span>, draw_width);
      shadow_canvas.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&#x27;height&#x27;</span>, draw_height);
      shadow_context.<span class="hljs-title function_">drawImage</span>(image, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, image.<span class="hljs-property">naturalWidth</span>, image.<span class="hljs-property">naturalHeight</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, draw_width, draw_height);
      <span class="hljs-keyword">var</span> imageData = shadow_context.<span class="hljs-title function_">getImageData</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, draw_width, draw_height);
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">resolve</span>({ <span class="hljs-attr">data</span>: imageData.<span class="hljs-property">data</span>, <span class="hljs-attr">width</span>: draw_width, <span class="hljs-attr">height</span>: draw_height });
    }
    image.<span class="hljs-property">src</span> = src; 
  })
  <span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>){
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;DOMContentLoaded&#x27;</span>,<span class="hljs-variable language_">this</span>.<span class="hljs-property">init</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;touchmove&#x27;</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleMousemove</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;mousemove&#x27;</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleMousemove</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;mousedown&#x27;</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleMousedown</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;touchstart&#x27;</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleMousedown</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;mouseup&#x27;</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleMouseup</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;touchend&#x27;</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleMouseup</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">globes</span> = [];
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">els</span> = [];
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">frame</span> = <span class="hljs-number">0</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">globe_size</span> = <span class="hljs-number">360</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">r1</span> = [<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>];
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">active</span> = <span class="hljs-literal">false</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">processing</span> = <span class="hljs-literal">false</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">grab_to_rotate</span> = <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"></span>){
      <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">raf</span>) <span class="hljs-title function_">cancelAnimationFrame</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">raf</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">root</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;root&#x27;</span>);
      <span class="hljs-comment">// const load_image = await getImageData({ src: &#x27;earth.png&#x27;, size: this.globe_size });</span>
      <span class="hljs-comment">// this.map_image_data = load_image.data;</span>
      <span class="hljs-comment">// this.width = load_image.width;</span>
      <span class="hljs-comment">// this.height = load_image.height;</span>
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setMapProjectionImage</span>(<span class="hljs-string">&#x27;earth.png&#x27;</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">els</span>.<span class="hljs-property">canvas_globe</span> = <span class="hljs-title function_">createNode</span>({ <span class="hljs-attr">root</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">root</span>, <span class="hljs-attr">tag</span>: <span class="hljs-string">&#x27;canvas&#x27;</span>, <span class="hljs-attr">attributes</span>: { <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">globe_size</span>, <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">globe_size</span> } });
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">els</span>.<span class="hljs-property">actions</span> = <span class="hljs-title function_">createNode</span>({ <span class="hljs-attr">root</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">root</span>, <span class="hljs-attr">tag</span>: <span class="hljs-string">&#x27;div&#x27;</span>, <span class="hljs-attr">className</span>: <span class="hljs-string">&#x27;actions&#x27;</span>, <span class="hljs-attr">innerHTML</span>: <span class="hljs-string">`
        &lt;button data-src=&quot;earth.png&quot;&gt;Earth&lt;/button&gt;
        &lt;button data-src=&quot;moon.jpg&quot;&gt;Moon&lt;/button&gt;
        &lt;button data-src=&quot;mars.jpeg&quot;&gt;Mars&lt;/button&gt;
        &lt;button data-src=&quot;spongebob.jpeg&quot;&gt;Spongebob&lt;/button&gt;
        &lt;button data-grab_toggle=&quot;true&quot;&gt;Toggle Grab&lt;/button&gt;
      `</span> });
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">els</span>.<span class="hljs-property">actions</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;click&#x27;</span>,<span class="hljs-variable language_">this</span>.<span class="hljs-property">handleChangeMap</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>))
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">els</span>.<span class="hljs-property">canvas_globe</span>.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">&#x27;2d&#x27;</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">projection</span> = d3.<span class="hljs-property">geo</span>.<span class="hljs-title function_">orthographic</span>().<span class="hljs-title function_">scale</span>( (<span class="hljs-variable language_">this</span>.<span class="hljs-property">globe_size</span> / <span class="hljs-number">2</span>) + <span class="hljs-number">1.5</span>).<span class="hljs-title function_">translate</span>([<span class="hljs-variable language_">this</span>.<span class="hljs-property">globe_size</span> / <span class="hljs-number">2</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">globe_size</span> / <span class="hljs-number">2</span>]).<span class="hljs-title function_">rotate</span>([<span class="hljs-number">0</span>,-<span class="hljs-number">20</span>,-<span class="hljs-number">20</span>]).<span class="hljs-title function_">clipAngle</span>(<span class="hljs-number">90</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">path</span> = d3.<span class="hljs-property">geo</span>.<span class="hljs-title function_">path</span>().<span class="hljs-title function_">projection</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">projection</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">lambda</span> = d3.<span class="hljs-property">scale</span>.<span class="hljs-title function_">linear</span>().<span class="hljs-title function_">domain</span>([<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span>]).<span class="hljs-title function_">range</span>([-<span class="hljs-number">180</span>, <span class="hljs-number">180</span>]);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">phi</span> = d3.<span class="hljs-property">scale</span>.<span class="hljs-title function_">linear</span>().<span class="hljs-title function_">domain</span>([<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">height</span>]).<span class="hljs-title function_">range</span>([<span class="hljs-number">90</span>, -<span class="hljs-number">90</span>]);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">raf</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">render</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));
    }
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">setMapProjectionImage</span>(<span class="hljs-params">src</span>) {
      <span class="hljs-keyword">const</span> load_image = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getImageData</span>({ <span class="hljs-attr">src</span>: src, <span class="hljs-attr">size</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">globe_size</span> });
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">map_image_data</span> = load_image.<span class="hljs-property">data</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span> = load_image.<span class="hljs-property">width</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">height</span> = load_image.<span class="hljs-property">height</span>;
    }
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleChangeMap</span>(<span class="hljs-params">event</span>) {
      <span class="hljs-keyword">if</span>(event.<span class="hljs-property">target</span>.<span class="hljs-property">dataset</span>.<span class="hljs-property">src</span>){
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setMapProjectionImage</span>(event.<span class="hljs-property">target</span>.<span class="hljs-property">dataset</span>.<span class="hljs-property">src</span>);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(event.<span class="hljs-property">target</span>.<span class="hljs-property">dataset</span>.<span class="hljs-property">grab_toggle</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">grab_to_rotate</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">grab_to_rotate</span>;
      }
    }
    <span class="hljs-title function_">handleMousedown</span>(<span class="hljs-params">event</span>){
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">active</span> = !!event.<span class="hljs-property">target</span>.<span class="hljs-title function_">closest</span>(<span class="hljs-string">&#x27;canvas&#x27;</span>);
      <span class="hljs-keyword">if</span>(!<span class="hljs-variable language_">this</span>.<span class="hljs-property">active</span>) <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">const</span> clientX = !!event.<span class="hljs-property">touches</span> ? event.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>].<span class="hljs-property">layerX</span> : event.<span class="hljs-property">layerX</span>;
      <span class="hljs-keyword">const</span> clientY = !!event.<span class="hljs-property">touches</span> ? event.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>].<span class="hljs-property">layerY</span> : event.<span class="hljs-property">layerY</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">v0</span> = versor.<span class="hljs-title function_">cartesian</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">projection</span>.<span class="hljs-title function_">invert</span>([clientX, clientY]));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">r0</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">projection</span>.<span class="hljs-title function_">rotate</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">q0</span> = <span class="hljs-title function_">versor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">r0</span>);
    }
    <span class="hljs-title function_">handleMousemove</span>(<span class="hljs-params">event</span>){
      <span class="hljs-keyword">if</span>(!<span class="hljs-variable language_">this</span>.<span class="hljs-property">active</span>) <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">const</span> clientX = !!event.<span class="hljs-property">touches</span> ? event.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>].<span class="hljs-property">layerX</span> : event.<span class="hljs-property">layerX</span>;
      <span class="hljs-keyword">const</span> clientY = !!event.<span class="hljs-property">touches</span> ? event.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>].<span class="hljs-property">layerY</span> : event.<span class="hljs-property">layerY</span>;      
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">v1</span> = versor.<span class="hljs-title function_">cartesian</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">projection</span>.<span class="hljs-title function_">rotate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">r0</span>).<span class="hljs-title function_">invert</span>([clientX, clientY]));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">q1</span> = versor.<span class="hljs-title function_">multiply</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">q0</span>, versor.<span class="hljs-title function_">delta</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">v0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">v1</span>));
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">r1</span> = versor.<span class="hljs-title function_">rotation</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">q1</span>);
    }
    <span class="hljs-title function_">handleMouseup</span>(<span class="hljs-params">event</span>){
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">active</span> = <span class="hljs-literal">false</span>;
    }
    <span class="hljs-title function_">updateLayerImageData</span>(<span class="hljs-params">img_data</span>){
      <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">processing</span>) <span class="hljs-keyword">return</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">processing</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8ClampedArray</span>(img_data.<span class="hljs-property">length</span>);
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> y = <span class="hljs-number">0</span>; y &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">height</span>; ++y) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> x = <span class="hljs-number">0</span>; x &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span>; ++x) {
          <span class="hljs-keyword">const</span> index = (y * <span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span> + x) * <span class="hljs-number">4</span>;
          <span class="hljs-keyword">const</span> [lambda,phi] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">projection</span>.<span class="hljs-title function_">invert</span>([x, y]);
          <span class="hljs-keyword">let</span> imageX = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">trunc</span>((lambda + <span class="hljs-number">180</span>) / <span class="hljs-number">360</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span>); 
          <span class="hljs-keyword">let</span> imageY = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">trunc</span>((<span class="hljs-number">90</span> - phi) / <span class="hljs-number">180</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">height</span>);
          <span class="hljs-keyword">const</span> imageIndex = (imageY * <span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span> + imageX) * <span class="hljs-number">4</span>;    
          data[index] = img_data[imageIndex];
          data[index + <span class="hljs-number">1</span>] = img_data[imageIndex + <span class="hljs-number">1</span>];
          data[index + <span class="hljs-number">2</span>] = img_data[imageIndex + <span class="hljs-number">2</span>];
          data[index + <span class="hljs-number">3</span>] = <span class="hljs-number">255</span>;
          <span class="hljs-keyword">if</span>(y === <span class="hljs-variable language_">this</span>.<span class="hljs-property">height</span> -<span class="hljs-number">1</span> &amp;&amp; x === <span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span> -<span class="hljs-number">1</span> ) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">processing</span> = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImageData</span>(data, <span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">height</span>);
          }
        }
      }
    }
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>){
      <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">grab_to_rotate</span>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">projection</span>.<span class="hljs-title function_">rotate</span>([<span class="hljs-variable language_">this</span>.<span class="hljs-property">r1</span>[<span class="hljs-number">0</span>], <span class="hljs-variable language_">this</span>.<span class="hljs-property">r1</span>[<span class="hljs-number">1</span>], <span class="hljs-variable language_">this</span>.<span class="hljs-property">r1</span>[<span class="hljs-number">2</span>]]);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">frame</span> += <span class="hljs-number">1</span>;
        <span class="hljs-keyword">const</span> rotation = <span class="hljs-variable language_">this</span>.<span class="hljs-property">frame</span> * <span class="hljs-number">0.5</span>;
        <span class="hljs-keyword">const</span> lambda = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">lambda</span>(rotation);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">projection</span>.<span class="hljs-title function_">rotate</span>([lambda , -<span class="hljs-number">20</span>, -<span class="hljs-number">20</span> ]);
      }
      <span class="hljs-keyword">const</span> updatedMapImageData = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateLayerImageData</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">map_image_data</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">clearRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">globe_size</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">globe_size</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">putImageData</span>(updatedMapImageData, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">raf</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">render</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));
    }
  }
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">App</span>(); 
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="language-css">
    <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">background</span>: <span class="hljs-number">#000</span> }
    <span class="hljs-selector-id">#root</span> { <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>; <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>; <span class="hljs-attribute">overflow</span>: hidden; <span class="hljs-attribute">display</span>: flex; <span class="hljs-attribute">flex-direction</span>: column; <span class="hljs-attribute">align-items</span>: center; <span class="hljs-attribute">justify-content</span>: center; <span class="hljs-attribute">position</span>: relative; <span class="hljs-attribute">z-index</span>: <span class="hljs-number">2</span>; }
    <span class="hljs-selector-id">#root</span> { 
      <span class="hljs-attribute">background-image</span>: 
        <span class="hljs-built_in">radial-gradient</span>(<span class="hljs-number">2px</span> <span class="hljs-number">2px</span> at <span class="hljs-number">20px</span> <span class="hljs-number">30px</span>, <span class="hljs-number">#eee</span>, <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)),
        <span class="hljs-built_in">radial-gradient</span>(<span class="hljs-number">2px</span> <span class="hljs-number">2px</span> at <span class="hljs-number">40px</span> <span class="hljs-number">70px</span>, <span class="hljs-number">#fff</span>, <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)),
        <span class="hljs-built_in">radial-gradient</span>(<span class="hljs-number">2px</span> <span class="hljs-number">2px</span> at <span class="hljs-number">50px</span> <span class="hljs-number">160px</span>, <span class="hljs-number">#ddd</span>, <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)),
        <span class="hljs-built_in">radial-gradient</span>(<span class="hljs-number">2px</span> <span class="hljs-number">2px</span> at <span class="hljs-number">90px</span> <span class="hljs-number">40px</span>, <span class="hljs-number">#fff</span>, <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)),
        <span class="hljs-built_in">radial-gradient</span>(<span class="hljs-number">2px</span> <span class="hljs-number">2px</span> at <span class="hljs-number">130px</span> <span class="hljs-number">80px</span>, <span class="hljs-number">#fff</span>, <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)),
        <span class="hljs-built_in">radial-gradient</span>(<span class="hljs-number">2px</span> <span class="hljs-number">2px</span> at <span class="hljs-number">160px</span> <span class="hljs-number">120px</span>, <span class="hljs-number">#ddd</span>, <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>));
      <span class="hljs-attribute">background-repeat</span>: repeat; <span class="hljs-attribute">background-size</span>: <span class="hljs-number">200px</span> <span class="hljs-number">200px</span> }
    <span class="hljs-selector-tag">canvas</span> { <span class="hljs-attribute">display</span>: block; <span class="hljs-attribute">image-rendering</span>: pixelated; <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>; <span class="hljs-attribute">cursor</span>: grab; <span class="hljs-attribute">position</span>: relative; }
    <span class="hljs-selector-tag">canvas</span><span class="hljs-selector-pseudo">:active</span> { <span class="hljs-attribute">cursor</span>: grabbing;}
    <span class="hljs-selector-class">.actions</span> { <span class="hljs-attribute">padding</span>: <span class="hljs-number">40px</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span>; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;root&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;space&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;stars&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;stars&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;stars&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;stars&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;stars&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
   <p>I used D3 previously to add SVG paths to an orthographic project, but what about an image? I first set out to find some quality map flat map images. For my example, I use an assortment of planetary projections, but any image will work.</p>
   <p>I first load the image data from file, and on each rAF interval, the pixel data is manipulated to fit onto the projection. Its not very performant with large images, but is effective for its simplicity. Lastly, a CSS starfield in the background for a nice touch.</p>
   <p><strong>Project Assets</strong></p>
   <table>
    <thead>
     <tr>
      <th style="text-align:left">Asset</th>
      <th style="text-align:left">File</th>
      <th style="text-align:left">Description</th>
     </tr>
    </thead>
    <tbody>
     <tr>
      <td style="text-align:left"><code>earth.png</code></td>
      <td style="text-align:left"><a href="https://iamjohnmills.github.io/journal/d3-orthographic-image/earth.png">Download</a></td>
      <td style="text-align:left">Earth</td>
     </tr>
     <tr>
      <td style="text-align:left"><code>mars.jpeg</code></td>
      <td style="text-align:left"><a href="https://iamjohnmills.github.io/journal/d3-orthographic-image/mars.jpeg">Download</a></td>
      <td style="text-align:left">Mars</td>
     </tr>
     <tr>
      <td style="text-align:left"><code>moon.jpg</code></td>
      <td style="text-align:left"><a href="https://iamjohnmills.github.io/journal/d3-orthographic-image/moon.jpg">Download</a></td>
      <td style="text-align:left">Moon</td>
     </tr>
     <tr>
      <td style="text-align:left"><code>spongebob.jpeg</code></td>
      <td style="text-align:left"><a href="https://iamjohnmills.github.io/journal/d3-orthographic-image/spongebob.jpeg">Download</a></td>
      <td style="text-align:left">Spongebob</td>
     </tr>
     <tr>
      <td style="text-align:left"><code>d3.v3.min.js</code></td>
      <td style="text-align:left"><a href="https://iamjohnmills.github.io/journal/d3-orthographic-image/d3.v3.min.js">Download</a></td>
      <td style="text-align:left">D3</td>
     </tr>
     <tr>
      <td style="text-align:left"><code>d3-geo.v1.min.js</code></td>
      <td style="text-align:left"><a href="https://iamjohnmills.github.io/journal/d3-orthographic-image/d3-geo.v1.min.js">Download</a></td>
      <td style="text-align:left">D3 Geo (for creating the orthographic projection)</td>
     </tr>
     <tr>
      <td style="text-align:left"><code>versor.js</code></td>
      <td style="text-align:left"><a href="https://iamjohnmills.github.io/journal/d3-orthographic-image/versor.js">Download</a></td>
      <td style="text-align:left">Versor.js (for panning the globe)</td>
     </tr>
    </tbody>
   </table>
   <aside>
    <figure>
     <img src="https://iamjohnmills.github.io/journal/assets/jm-photo-2023.jpg" />
    </figure>
    <p>I'm John Mills, a professional frontend engineer. Here I share my experiences and journeys with all of you. Check out all my projects on <a href="https://github.com/iamjohnmills" target="_blank">Github</a>. Message or connect with me on <a href="https://www.linkedin.com/in/iamjohnmills" target="_blank">LinkedIn</a>. I'm a proud dad of my two daughters, cook sometimes, and am interested in a ton of weird stuff.</p>
   </aside>
  </section>
 </main>
</body>

</html>